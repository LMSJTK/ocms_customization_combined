<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNS Message Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .controls button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .controls button:hover {
            background: #2980b9;
        }

        .controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2c3e50;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #2c3e50;
            font-size: 32px;
            font-weight: bold;
        }

        .messages {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .message {
            border-bottom: 1px solid #e1e8ed;
            padding: 20px;
        }

        .message:last-child {
            border-bottom: none;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .message-id {
            font-family: monospace;
            color: #7f8c8d;
            font-size: 12px;
        }

        .message-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .message-status.sent {
            background: #d4edda;
            color: #155724;
        }

        .message-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .message-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message-meta div {
            color: #7f8c8d;
        }

        .message-meta strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 4px;
        }

        .message-data {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .message-data pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .toggle-data {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .toggle-data:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SNS Message Monitor</h1>
            <p class="subtitle">View messages published to AWS SNS topic</p>
        </header>

        <div class="controls">
            <button onclick="loadMessages()">Refresh</button>
            <label>
                <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()">
                Auto-refresh (10s)
            </label>
            <label>
                <input type="checkbox" id="show-sent" checked onchange="loadMessages()">
                Show sent
            </label>
            <label>
                <input type="checkbox" id="show-pending" checked onchange="loadMessages()">
                Show pending
            </label>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Messages</h3>
                <div class="value" id="stat-total">-</div>
            </div>
            <div class="stat-card">
                <h3>Sent to SNS</h3>
                <div class="value" id="stat-sent">-</div>
            </div>
            <div class="stat-card">
                <h3>Pending</h3>
                <div class="value" id="stat-pending">-</div>
            </div>
            <div class="stat-card">
                <h3>Last Updated</h3>
                <div class="value" style="font-size: 16px;" id="stat-updated">Never</div>
            </div>
        </div>

        <div class="messages" id="messages-container">
            <div class="loading">Loading messages...</div>
        </div>
    </div>

    <script>
        // Auto-detect base path
        const currentPath = window.location.pathname;
        let basePath = currentPath.substring(0, currentPath.lastIndexOf('/'));
        if (basePath.endsWith('/public')) {
            basePath = basePath.substring(0, basePath.lastIndexOf('/'));
        }
        const API_BASE = basePath + '/api';

        let autoRefreshInterval = null;

        function toggleAutoRefresh() {
            const enabled = document.getElementById('auto-refresh').checked;
            if (enabled) {
                loadMessages();
                autoRefreshInterval = setInterval(loadMessages, 10000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        async function loadMessages() {
            const showSent = document.getElementById('show-sent').checked;
            const showPending = document.getElementById('show-pending').checked;

            try {
                const response = await fetch(API_BASE + '/sns-messages.php');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load messages');
                }

                // Update stats
                document.getElementById('stat-total').textContent = data.stats.total;
                document.getElementById('stat-sent').textContent = data.stats.sent;
                document.getElementById('stat-pending').textContent = data.stats.pending;
                document.getElementById('stat-updated').textContent = new Date().toLocaleTimeString();

                // Filter messages
                let messages = data.messages;
                if (!showSent || !showPending) {
                    messages = messages.filter(msg => {
                        if (msg.sent && !showSent) return false;
                        if (!msg.sent && !showPending) return false;
                        return true;
                    });
                }

                // Render messages
                renderMessages(messages);

            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messages-container').innerHTML =
                    '<div class="empty-state">Error loading messages: ' + error.message + '</div>';
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages-container');

            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state">No messages found</div>';
                return;
            }

            container.innerHTML = messages.map((msg, index) => {
                const messageData = typeof msg.message_data === 'string'
                    ? JSON.parse(msg.message_data)
                    : msg.message_data;

                return `
                    <div class="message">
                        <div class="message-header">
                            <div class="message-id">ID: ${msg.id}</div>
                            <div class="message-status ${msg.sent ? 'sent' : 'pending'}">
                                ${msg.sent ? 'âœ“ Sent' : 'Pending'}
                            </div>
                        </div>
                        <div class="message-meta">
                            <div>
                                <strong>Tracking Link</strong>
                                ${msg.tracking_link_id}
                            </div>
                            <div>
                                <strong>Recipient</strong>
                                ${messageData.recipient_id || 'N/A'}
                            </div>
                            <div>
                                <strong>Content</strong>
                                ${messageData.content_id || 'N/A'}
                            </div>
                            <div>
                                <strong>Created</strong>
                                ${new Date(msg.created_at).toLocaleString()}
                            </div>
                            ${msg.sent_at ? `
                            <div>
                                <strong>Sent to SNS</strong>
                                ${new Date(msg.sent_at).toLocaleString()}
                            </div>
                            ` : ''}
                        </div>
                        <button class="toggle-data" onclick="toggleData(${index})">
                            Show Message Data
                        </button>
                        <div class="message-data" id="data-${index}" style="display: none;">
                            <pre>${JSON.stringify(messageData, null, 2)}</pre>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleData(index) {
            const dataDiv = document.getElementById('data-' + index);
            const button = event.target;
            if (dataDiv.style.display === 'none') {
                dataDiv.style.display = 'block';
                button.textContent = 'Hide Message Data';
            } else {
                dataDiv.style.display = 'none';
                button.textContent = 'Show Message Data';
            }
        }

        // Load messages on page load
        loadMessages();
    </script>
</body>
</html>
